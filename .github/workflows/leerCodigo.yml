name: Analisis de Codigo - Seguridad y Buenas Prácticas

on:
  workflow_dispatch:

jobs:
  validar_codigo:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      ###########################################################
      # 1. Compilar proyecto
      ###########################################################
      - name: Compilar proyecto
        run: mvn -q clean compile test-compile

      ###########################################################
      # 2. Ejecutar análisis
      ###########################################################
      - name: Checkstyle
        run: mvn -q checkstyle:check || true

      - name: PMD Analysis
        run: mvn -q pmd:pmd || true

      - name: SpotBugs Analysis
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:check || true

      ###########################################################
      # 3. Generar Reporte HTML consolidado
      ###########################################################
      - name: Generar reporte HTML consolidado
        shell: bash
        run: |
          echo "<html><head><meta charset='UTF-8'><title>Reporte de Análisis</title>" > reporte.html
          echo "<style>body{font-family:Arial;} table{border-collapse:collapse;width:100%;} th,td{border:1px solid #ccc;padding:5px;} th{background:#eee;}</style>" >> reporte.html
          echo "</head><body>" >> reporte.html
          echo "<h1>Reporte Consolidado de Análisis de Código</h1>" >> reporte.html
          
          #####################################################
          # CHECKSTYLE
          #####################################################
          echo "<h2>Checkstyle</h2>" >> reporte.html

          if grep -q "<error " target/checkstyle-result.xml; then
            echo "<table><tr><th>Archivo</th><th>Línea</th><th>Descripción</th></tr>" >> reporte.html

            CURRENT_FILE=""
            while IFS= read -r line; do
              if echo "$line" | grep -q "<file name="; then
                CURRENT_FILE=$(echo "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
              fi

              if echo "$line" | grep -q "<error "; then
                LINEA=$(echo "$line" | sed -n 's/.*line="\([^"]*\)".*/\1/p')
                MSG=$(echo "$line" | sed -n 's/.*message="\([^"]*\)".*/\1/p')

                echo "<tr><td>$CURRENT_FILE</td><td>$LINEA</td><td>$MSG</td></tr>" >> reporte.html
              fi
            done < target/checkstyle-result.xml

            echo "</table>" >> reporte.html
          else
            echo "<p>✔ Sin problemas detectados.</p>" >> reporte.html
          fi

          #####################################################
          # PMD (CORREGIDO)
          #####################################################
          echo "<h2>PMD</h2>" >> reporte.html

          if grep -q "<violation" target/pmd.xml; then
            echo "<table><tr><th>Archivo</th><th>Línea</th><th>Recomendación</th></tr>" >> reporte.html

            CURRENT_FILE=""
            while IFS= read -r line; do
              # Detectar archivo
              if echo "$line" | grep -q "<file name="; then
                CURRENT_FILE=$(echo "$line" | sed -n 's/.*name="\([^"]*\)".*/\1/p')
              fi

              # Detectar violación
              if echo "$line" | grep -q "<violation"; then
                LINEA=$(echo "$line" | sed -n 's/.*beginline="\([^"]*\)".*/\1/p')
                RAW_MSG=$(echo "$line" | sed -n 's/.*>\(.*\)<.*/\1/p')

                # Reglas de recomendación
                MSG="$RAW_MSG"
                if echo "$RAW_MSG" | grep -qi "Unused import"; then
                  MSG="Elimina el import no utilizado."
                elif echo "$RAW_MSG" | grep -qi "Unnecessary"; then
                  MSG="Refactoriza para eliminar código o calificación innecesaria."
                elif echo "$RAW_MSG" | grep -qi "Long"; then
                  MSG="Reduce la longitud del método o clase para mejorar legibilidad."
                fi

                echo "<tr><td>$CURRENT_FILE</td><td>$LINEA</td><td>$MSG</td></tr>" >> reporte.html
              fi
            done < target/pmd.xml

            echo "</table>" >> reporte.html
          else
            echo "<p>✔ Sin problemas detectados.</p>" >> reporte.html
          fi

          #####################################################
          # SPOTBUGS
          #####################################################
          echo "<h2>SpotBugs</h2>" >> reporte.html

          if grep -q "<BugInstance" target/spotbugsXml.xml; then
            echo "<table><tr><th>Archivo</th><th>Línea</th><th>Tipo de Bug</th></tr>" >> reporte.html

            CURRENT_FILE=""
            while IFS= read -r line; do
              if echo "$line" | grep -q "<SourceLine"; then
                CURRENT_FILE=$(echo "$line" | sed -n 's/.*sourcepath="\([^"]*\)".*/\1/p')
                LINEA=$(echo "$line" | sed -n 's/.*start="\([^"]*\)".*/\1/p')
              fi

              if echo "$line" | grep -q "<BugInstance"; then
                BUG_TYPE=$(echo "$line" | sed -n 's/.*type="\([^"]*\)".*/\1/p')
                echo "<tr><td>$CURRENT_FILE</td><td>$LINEA</td><td>$BUG_TYPE</td></tr>" >> reporte.html
              fi
            done < target/spotbugsXml.xml

            echo "</table>" >> reporte.html
          else
            echo "<p>✔ Sin bugs detectados.</p>" >> reporte.html
          fi

          echo "</body></html>" >> reporte.html

      ###########################################################
      # 4. Subir artefactos
      ###########################################################
      - name: Subir reportes
        uses: actions/upload-artifact@v4
        with:
          name: reporte_analisis
          path: reporte.html
