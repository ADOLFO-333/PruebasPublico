name: Leer C√≥digo - Seguridad y Buenas Pr√°cticas

on:
  workflow_dispatch:

jobs:
  validar_codigo:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # 1. Compilaci√≥n del Proyecto
      # ----------------------------------------------------------------------
      - name: Compilar proyecto
        run: mvn -q clean compile test-compile

      # ----------------------------------------------------------------------
      # 2. An√°lisis de C√≥digo
      # ----------------------------------------------------------------------
      - name: Checkstyle
        run: mvn -q checkstyle:check || true

      - name: PMD Analysis
        run: mvn -q pmd:pmd || true

      - name: SpotBugs Analysis
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:check || true

      # ----------------------------------------------------------------------
      # 3. Generar Reporte HTML Embellecido
      # ----------------------------------------------------------------------
      - name: Generar reporte HTML consolidado
        run: |
          echo "<html><head><meta charset='UTF-8'><title>Reporte de An√°lisis de C√≥digo</title></head><body>" > reporte.html
          echo "<h1>üéØ Reporte Consolidado de An√°lisis de C√≥digo</h1>" >> reporte.html
          echo "<p>Este informe resume los hallazgos de <b>Checkstyle</b>, <b>PMD</b> y <b>SpotBugs</b>.</p>" >> reporte.html
          echo "<hr>" >> reporte.html

          # =======================
          # CHECKSTYLE
          # =======================
          echo "<h2>üßπ Checkstyle ‚Äì Formato y Estilo</h2>" >> reporte.html
          if grep -q "<error " target/checkstyle-result.xml; then
            echo "<table border='1'><tr><th>Archivo</th><th>L√≠nea</th><th>Mensaje</th><th>Recomendaci√≥n</th></tr>" >> reporte.html
            awk '
              /<file name="/ { gsub(/.*name="|">/, ""); file=$0 }
              /<error / {
                match($0, /line="([0-9]+)"/, a);
                line=a[1];
                match($0, /message="([^"]+)"/, b);
                msg=b[1];
                reco="Corrige el formato o estilo seg√∫n Checkstyle.";
                print "<tr><td>"file"</td><td>"line"</td><td>"msg"</td><td>"reco"</td></tr>"
              }
            ' target/checkstyle-result.xml >> reporte.html
            echo "</table>" >> reporte.html
          else
            echo "<p>‚úî Sin problemas detectados.</p>" >> reporte.html
          fi
          echo "<hr>" >> reporte.html

          # =======================
          # PMD
          # =======================
          echo "<h2>üìè PMD ‚Äì Buenas Pr√°cticas & Complejidad</h2>" >> reporte.html
          if grep -q "<violation " target/pmd.xml; then
            echo "<table border='1'><tr><th>Archivo</th><th>L√≠nea</th><th>Mensaje</th><th>Recomendaci√≥n</th></tr>" >> reporte.html
            awk -F'"' '
              /<file name/ {file=$2}
              /<violation / {
                split($0,a,"beginline=\""); split(a[2],b,"\""); line=b[1];
                match($0, />[^<]+/, m);
                msg=substr(m[0],2);
                reco="Revisa buenas pr√°cticas y complejidad seg√∫n PMD.";
                print "<tr><td>"file"</td><td>"line"</td><td>"msg"</td><td>"reco"</td></tr>"
              }
            ' target/pmd.xml >> reporte.html
            echo "</table>" >> reporte.html
          else
            echo "<p>‚úî Sin problemas detectados.</p>" >> reporte.html
          fi
          echo "<hr>" >> reporte.html

          # =======================
          # SPOTBUGS
          # =======================
          echo "<h2>üêõ SpotBugs ‚Äì Posibles Bugs Reales</h2>" >> reporte.html
          if grep -q "<BugInstance" target/spotbugsXml.xml; then
            echo "<table border='1'><tr><th>Archivo</th><th>L√≠nea</th><th>Tipo de Bug</th><th>Recomendaci√≥n</th></tr>" >> reporte.html
            awk -F'"' '
              /<Class / {class=$2}
              /<BugInstance / {
                match($0, /type="([^"]+)"/, a);
                tipo=a[1];
                reco="Revisa posible bug y aplica correcci√≥n seg√∫n SpotBugs.";
                getline
                match($0, /start="([0-9]+)"/, b);
                line=b[1];
                print "<tr><td>"class"</td><td>"line"</td><td>"tipo"</td><td>"reco"</td></tr>"
              }
            ' target/spotbugsXml.xml >> reporte.html
            echo "</table>" >> reporte.html
          else
            echo "<p>‚úî Sin bugs detectados.</p>" >> reporte.html
          fi

          # =======================
          # Recomendaciones finales
          # =======================
          echo "<hr>" >> reporte.html
          echo "<h2>üí° Recomendaciones Generales</h2>" >> reporte.html
          echo "<ul>" >> reporte.html
          echo "<li>Divide Tasks muy largas en subtareas Screenplay.</li>" >> reporte.html
          echo "<li>Usa Page Objects limpios y descriptivos.</li>" >> reporte.html
          echo "<li>Evita duplicaci√≥n en Steps/Interactions.</li>" >> reporte.html
          echo "<li>Aplica formateo autom√°tico (Ctrl + Alt + L en IntelliJ).</li>" >> reporte.html
          echo "<li>Revisa posibles NPE detectados por SpotBugs.</li>" >> reporte.html
          echo "<li>Mant√©n clases por debajo de 300 l√≠neas para Screenplay.</li>" >> reporte.html
          echo "</ul>" >> reporte.html
          echo "</body></html>" >> reporte.html

      # ----------------------------------------------------------------------
      # 4. Subir resultados
      # ----------------------------------------------------------------------
      - name: Subir reportes originales
        uses: actions/upload-artifact@v4
        with:
          name: reportes_detallados
          path: |
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
            target/pmd.html
            target/site/spotbugs.html

      - name: Subir reporte embellecido
        uses: actions/upload-artifact@v4
        with:
          name: reporte_analisis_embellecido
          path: reporte.html
