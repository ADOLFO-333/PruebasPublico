# ----------------------------------------------------------------------
# Se le asigna un nombre al workflow
# ----------------------------------------------------------------------
name: Leer Código - Seguridad y Buenas Prácticas

# ----------------------------------------------------------------------
# Se ejecuta manualmente con el boton workflow
# ----------------------------------------------------------------------
on:
  workflow_dispatch:

jobs:
  validar_codigo:
    # ----------------------------------------------------------------------
    # Se ejecuta en un runner Ubuntu proporcionado por GitHub la ultima version
    # ----------------------------------------------------------------------
    runs-on: ubuntu-latest
    # ----------------------------------------------------------------------
    # tiene un tiempo maximo de 30 minutos por si no responde
    # ----------------------------------------------------------------------
    timeout-minutes: 30

    steps:
      # ----------------------------------------------------------------------
      # 1. Obtener el código fuente
      # clonamos el repositorio para poder trabajar con el con un action
      # ----------------------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # 2. Configurar Java
      # con un action instalamos y configuramos Java 17 porque el proyecto Serenity + Screenplay requiere JDK 17
      # ----------------------------------------------------------------------
      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ----------------------------------------------------------------------
      # 3. Cache de dependencias Maven
      # usamos un action que permite que las dependencias Maven no se descarguen cada vez, y sean guardadas en cache para reducir tiempos
      # ----------------------------------------------------------------------
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
        
      # ----------------------------------------------------------------------
      # 4. Compilación del proyecto
      # Compila el código fuente 
      # ----------------------------------------------------------------------
      - name: Compilar proyecto
        run: mvn -q clean compile test-compile
        

      # ----------------------------------------------------------------------
      # 5. Análisis de código estático
      # Checkstyle: analiza estilo de código y convenciones de Java
      # PMD: Detectar malas prácticas, código innecesariamente complejo o redundante
      # SpotBugs: detecta posibles bugs reales, como Null Pointer Exception o problemas de concurrencia
      # Se usa || true para que el pipeline no falle si hay errores devuelva exitoso y continue con la revision
      # ----------------------------------------------------------------------
      
      - name: Checkstyle
        run: mvn -q checkstyle:check || true        
     
      - name: PMD Analysis
        run: mvn -q pmd:pmd || true
      
      - name: SpotBugs Analysis
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:check || true

      # ----------------------------------------------------------------------
      # 6. Generar un reporte HTML 
      # ----------------------------------------------------------------------
      - name: Generar reporte HTML consolidado
        run: |
          # ----------------------------------------------------------------------
          # Crear el encabezado del HTML
          # ----------------------------------------------------------------------
          echo "<html><head><meta charset='UTF-8'><title>Reporte de Análisis de Código</title></head><body>" > reporte.html
          echo "<h1>Reporte Consolidado de Análisis de Código</h1>" >> reporte.html
          echo "<p>Este informe resume los hallazgos de <b>Checkstyle</b>, <b>PMD</b> y <b>SpotBugs</b>.</p>" >> reporte.html
          echo "<hr>" >> reporte.html

          # ----------------------------------------------------------------------
          # 6.1 Checkstyle
          # Crear tabla con columnas: Archivo, Línea, Mensaje, Recomendación. Se le da formato a la tabla y se formula lo que aparece en cada columna
          # ----------------------------------------------------------------------
          echo "<h2>Checkstyle – Formato y Estilo</h2>" >> reporte.html
          if grep -q "<error " target/checkstyle-result.xml; then
            echo "<table border='1'><tr><th>Archivo</th><th>Línea</th><th>Mensaje</th><th>Recomendación</th></tr>" >> reporte.html
            awk '
              /<file name="/ { gsub(/.*name="|">/, ""); file=$0 }
              /<error / {
                match($0, /line="([0-9]+)"/, a);
                line=a[1];
                match($0, /message="([^"]+)"/, b);
                msg=b[1];
                reco="Corrige el formato o estilo según Checkstyle.";
                print "<tr><td>"file"</td><td>"line"</td><td>"msg"</td><td>"reco"</td></tr>"
              }
            ' target/checkstyle-result.xml >> reporte.html
            echo "</table>" >> reporte.html
          else
            echo "<p>Sin problemas detectados.</p>" >> reporte.html
          fi
          echo "<hr>" >> reporte.html

          # ----------------------------------------------------------------------
          # 6.2 PMD
          # Crear tabla con columnas: Archivo, Línea, Mensaje, Recomendación. Se le da formato a la tabla y se formula lo que aparece en cada columna
          # ----------------------------------------------------------------------
          echo "<h2>PMD – Buenas Prácticas y Complejidad</h2>" >> reporte.html
          if grep -q "<violation " target/pmd.xml; then
            echo "<table border='1'><tr><th>Archivo</th><th>Línea</th><th>Mensaje</th><th>Recomendación</th></tr>" >> reporte.html
            awk -F'"' '
              /<file name/ {file=$2}
              /<violation / {
                split($0,a,"beginline=\""); split(a[2],b,"\""); line=b[1];
                match($0, />[^<]+/, m);
                msg=substr(m[0],2);
                reco="Revisa buenas prácticas y complejidad según PMD.";
                print "<tr><td>"file"</td><td>"line"</td><td>"msg"</td><td>"reco"</td></tr>"
              }
            ' target/pmd.xml >> reporte.html
            echo "</table>" >> reporte.html
          else
            echo "<p>Sin problemas detectados.</p>" >> reporte.html
          fi
          echo "<hr>" >> reporte.html

          # ----------------------------------------------------------------------
          # 6.3 SpotBugs
          # Crear tabla con columnas: Archivo, Línea, Tipo de Bug, Recomendación. Se le da formato a la tabla y se formula lo que aparece en cada columna
          # ----------------------------------------------------------------------
          echo "<h2>SpotBugs – Posibles Bugs Reales</h2>" >> reporte.html
          if grep -q "<BugInstance" target/spotbugsXml.xml; then
            echo "<table border='1'><tr><th>Archivo</th><th>Línea</th><th>Tipo de Bug</th><th>Recomendación</th></tr>" >> reporte.html
            awk -F'"' '
              /<Class / {class=$2}
              /<BugInstance / {
                match($0, /type="([^"]+)"/, a);
                tipo=a[1];
                reco="Revisa posible bug y aplica corrección según SpotBugs.";
                getline
                match($0, /start="([0-9]+)"/, b);
                line=b[1];
                print "<tr><td>"class"</td><td>"line"</td><td>"tipo"</td><td>"reco"</td></tr>"
              }
            ' target/spotbugsXml.xml >> reporte.html
            echo "</table>" >> reporte.html
          else
            echo "<p>Sin bugs detectados.</p>" >> reporte.html
          fi

          # ----------------------------------------------------------------------
          # 6.4 Recomendaciones finales generales
          # Se dejan unas recomendaciones quemadas en el archivo para que el usuario tenga en cuenta en sus desarrollos
          # ----------------------------------------------------------------------
          echo "<hr>" >> reporte.html
          echo "<h2>Recomendaciones Generales</h2>" >> reporte.html
          echo "<ul>" >> reporte.html
          echo "<li>Divide Tasks muy largas en subtareas Screenplay.</li>" >> reporte.html
          echo "<li>Usa Page Objects limpios y descriptivos.</li>" >> reporte.html
          echo "<li>Evita duplicación en Steps/Interactions.</li>" >> reporte.html
          echo "<li>Aplica formateo automático (Ctrl + Alt + L en IntelliJ).</li>" >> reporte.html
          echo "<li>Revisa posibles NPE detectados por SpotBugs.</li>" >> reporte.html
          echo "<li>Mantén clases por debajo de 300 líneas para Screenplay.</li>" >> reporte.html
          echo "</ul>" >> reporte.html
          echo "</body></html>" >> reporte.html

      # ----------------------------------------------------------------------
      # 7. Subir resultados para revisión
      # con un action subimos los reportes originales generados por las herramientas
      # ----------------------------------------------------------------------
      
      - name: Subir reportes originales
        uses: actions/upload-artifact@v4
        with:
          name: reportes_detallados
          path: |
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
            target/pmd.html
            target/site/spotbugs.html

      # ----------------------------------------------------------------------
      # con un action subimos el reporte HTML consolidado
      # ----------------------------------------------------------------------
      - name: Subir reporte embellecido
        uses: actions/upload-artifact@v4
        with:
          name: Carpeta_reporte_analisis
          path: reporte.html
