name: Leer C√≥digo - Seguridad y Buenas Pr√°cticas

on:
  workflow_dispatch:

jobs:
  validar_codigo:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Compilar proyecto
        run: mvn -q clean compile

      - name: Ejecutar Checkstyle
        run: mvn -q checkstyle:check || true

      - name: Ejecutar PMD
        run: mvn -q pmd:pmd || true

      - name: Ejecutar SpotBugs
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:spotbugs || true

      # ==========================================================
      # üî• GENERAR REPORTE HTML CLARO, BONITO Y EXPLICATIVO
      # ==========================================================
      - name: Crear reporte HTML consolidado
        run: |
          echo "<html><head><meta charset='UTF-8'>
          <style>
            body { font-family: Arial; margin: 20px; }
            h1 { color: #003366; }
            h2 { color: #0055aa; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
            th { background: #004A99; color: white; padding: 8px; }
            td { border: 1px solid #ddd; padding: 6px; }
            tr:nth-child(even) { background: #f2f2f2; }
            .ok { color: green; font-weight: bold; }
            .warn { color: orange; font-weight: bold; }
            .err { color: red; font-weight: bold; }
          </style>
          </head><body>" > reporte_final.html

          echo "<h1>üîé Reporte Consolidado de An√°lisis de C√≥digo</h1>" >> reporte_final.html
          echo "<p>Este reporte resume problemas detectados por <b>Checkstyle</b>, <b>PMD</b> y <b>SpotBugs</b>.</p>" >> reporte_final.html

          # ==========================================================
          # CHECKSTYLE
          # ==========================================================
          echo "<h2>üßπ Checkstyle ‚Äì Estilo y Convenciones</h2>" >> reporte_final.html

          if xmllint --xpath "count(/checkstyle/file/error)" target/checkstyle-result.xml 2>/dev/null | grep -q '^0$'; then
            echo "<p class='ok'>‚úî No se encontraron problemas.</p>" >> reporte_final.html
          else
            echo "<table><tr><th>Archivo</th><th>L√≠nea</th><th>Descripci√≥n</th><th>Recomendaci√≥n</th></tr>" >> reporte_final.html
            xmllint --xpath "/checkstyle/file" target/checkstyle-result.xml 2>/dev/null |
            xmllint --format - |
            grep "<file " |
            sed 's/<file /\n<file /g' |
            while read -r FILEBLOCK; do
              FILENAME=$(echo "$FILEBLOCK" | sed -n 's/.*name="\([^"]*\)".*/\1/p')

              echo "$FILEBLOCK" | grep "<error " | while read -r ERR; do
                LINE=$(echo "$ERR" | sed -n 's/.*line="\([^"]*\)".*/\1/p')
                MSG=$(echo "$ERR" | sed -n 's/.*message="\([^"]*\)".*/\1/p')

                # Reglas simples para recomendaciones
                if echo "$MSG" | grep -qi "Javadoc"; then
                  REC="Agregar comentarios Javadoc claros."
                elif echo "$MSG" | grep -qi "Parameter"; then
                  REC="Marcar par√°metros como final."
                elif echo "$MSG" | grep -qi "constructor"; then
                  REC="Hacer constructor privado para clase utilitaria."
                else
                  REC="Revisar formato o estilo seg√∫n Checkstyle."
                fi

                echo "<tr><td>$FILENAME</td><td>$LINE</td><td>$MSG</td><td>$REC</td></tr>" >> reporte_final.html
              done
            done
            echo "</table>" >> reporte_final.html
          fi

          # ==========================================================
          # PMD
          # ==========================================================
          echo "<h2>üìè PMD ‚Äì Buenas Pr√°cticas</h2>" >> reporte_final.html

          if xmllint --xpath "count(/pmd/file/violation)" target/pmd.xml 2>/dev/null | grep -q '^0$'; then
            echo "<p class='ok'>‚úî No se encontraron problemas.</p>" >> reporte_final.html
          else
            echo "<table><tr><th>Archivo</th><th>L√≠nea</th><th>Descripci√≥n</th><th>Recomendaci√≥n</th></tr>" >> reporte_final.html

            xmllint --xpath "/pmd/file" target/pmd.xml 2>/dev/null |
            sed 's/<file/\n<file/g' |
            while read -r BLOCK; do
              FILE=$(echo "$BLOCK" | sed -n 's/.*name="\([^"]*\)".*/\1/p')

              echo "$BLOCK" | grep "<violation" | while read -r V; do
                LINE=$(echo "$V" | sed -n 's/.*beginline="\([^"]*\)".*/\1/p')
                MSG=$(echo "$V" | sed -n 's/.*>\(.*\)<.*/\1/p')

                if echo "$MSG" | grep -qi "unused"; then
                  REC="Eliminar importaciones o variables no utilizadas."
                elif echo "$MSG" | grep -qi "qualifier"; then
                  REC="Evitar nombres completamente calificados innecesarios."
                else
                  REC="Revisar buenas pr√°cticas de PMD."
                fi

                echo "<tr><td>$FILE</td><td>$LINE</td><td>$MSG</td><td>$REC</td></tr>" >> reporte_final.html
              done
            done
            echo "</table>" >> reporte_final.html
          fi

          # ==========================================================
          # SPOTBUGS
          # ==========================================================
          echo "<h2>üêõ SpotBugs ‚Äì Posibles Bugs Reales</h2>" >> reporte_final.html

          if ! grep -q "<BugInstance" target/spotbugsXml.xml; then
            echo "<p class='ok'>‚úî No se detectaron bugs.</p>" >> reporte_final.html
          else
            echo "<table><tr><th>Archivo</th><th>L√≠nea</th><th>Tipo</th><th>Recomendaci√≥n</th></tr>" >> reporte_final.html

            grep "<BugInstance" -A2 target/spotbugsXml.xml | while read -r B; do
              TYPE=$(echo "$B" | sed -n 's/.*type="\([^"]*\)".*/\1/p')
              FILE=$(grep -A2 "$TYPE" target/spotbugsXml.xml | grep "SourceLine" | sed -n 's/.*sourcefile="\([^"]*\)".*/\1/p' | head -1)
              LINE=$(grep -A2 "$TYPE" target/spotbugsXml.xml | grep "SourceLine" | sed -n 's/.*start="\([^"]*\)".*/\1/p' | head -1)

              REC="Revisar posible bug reportado por SpotBugs."

              echo "<tr><td>$FILE</td><td>$LINE</td><td>$TYPE</td><td>$REC</td></tr>" >> reporte_final.html
            done

            echo "</table>" >> reporte_final.html
          fi

          echo "</body></html>" >> reporte_final.html

      - name: Subir reporte HTML
        uses: actions/upload-artifact@v4
        with:
          name: reporte_html
          path: reporte_final.html


