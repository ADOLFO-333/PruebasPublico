name: Leer C贸digo - Seguridad y Buenas Pr谩cticas

on:
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  validar_codigo:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Ajusta seg煤n el tama帽o de tu proyecto

    steps:
      # ------------------------------
      # 1. Checkout del repositorio
      # ------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------
      # 2. Configurar Java
      # ------------------------------
      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ------------------------------
      # 3. Cache de dependencias Maven
      # ------------------------------
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ------------------------------
      # 4. Compilar proyecto
      # ------------------------------
      - name: Compilar proyecto
        run: mvn -q clean compile test-compile

      # ------------------------------
      # 5. Ejecutar an谩lisis de c贸digo
      # ------------------------------
      - name: Checkstyle
        run: mvn -q checkstyle:check || true

      - name: PMD Analysis
        run: mvn -q pmd:pmd || true

      - name: SpotBugs Analysis
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:check || true

      # ------------------------------
      # 6. Generar reporte HTML avanzado
      # ------------------------------
      - name: Generar reporte HTML avanzado
        run: |
          cat << 'EOF' > reporte_final.html
          <html>
          <head>
            <meta charset='UTF-8'>
            <title>Reporte Avanzado de An谩lisis de C贸digo</title>
            <style>
              body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
              h1 { color: #1b4de4; }
              h2 { border-bottom: 2px solid #ddd; padding-bottom: 4px; color: #333; margin-top: 30px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th { background: #1b4de4; color: white; padding: 8px; }
              td { background: #fff; padding: 8px; border-bottom: 1px solid #ddd; }
              .ok { color: green; font-weight: bold; }
              .warn { color: orange; font-weight: bold; }
              .err { color: red; font-weight: bold; }
              .section { margin-top: 30px; }
            </style>
          </head>
          <body>
            <h1> Reporte Avanzado de An谩lisis de C贸digo</h1>
            <p>Este reporte consolida los resultados de <b>Checkstyle</b>, <b>PMD</b> y <b>SpotBugs</b>.</p>
            <div class="section">
              <h2> Resumen General</h2>
EOF

          # ----- Contar errores por herramienta -----
          CS_COUNT=$(grep "<error " target/checkstyle-result.xml | wc -l || echo 0)
          PMD_COUNT=$(grep "<violation" target/pmd.xml | wc -l || echo 0)
          SB_COUNT=$(grep "<BugInstance" target/spotbugsXml.xml | wc -l || echo 0)

          echo "<ul>" >> reporte_final.html
          echo "<li>Checkstyle: $CS_COUNT problemas</li>" >> reporte_final.html
          echo "<li>PMD: $PMD_COUNT problemas</li>" >> reporte_final.html
          echo "<li>SpotBugs: $SB_COUNT bugs</li>" >> reporte_final.html
          echo "</ul>" >> reporte_final.html

          # ----- Funci贸n para mensaje amigable -----
          explain() {
            case "$1" in
              *unused* ) echo "Variable declarada pero no usada. Ejemplo: eliminarla." ;;
              *NullPointer* ) echo "Posible NullPointerException. Verifica null antes de usar." ;;
              * ) echo "Revisa este error seg煤n la regla correspondiente." ;;
            esac
          }

          # ----- Checkstyle -----
          grep "<error " target/checkstyle-result.xml > cs_temp.txt || true
          if [ $(wc -l < cs_temp.txt) -eq 0 ]; then
            echo "<div class='section'><h2>Ч Checkstyle</h2><p class='ok'> Sin problemas detectados.</p></div>" >> reporte_final.html
          else
            echo "<div class='section'><h2>Ч Checkstyle</h2><p class='err'> Problemas detectados:</p><table><tr><th>Archivo</th><th>L铆nea</th><th>Descripci贸n</th><th>Explicaci贸n / Ejemplo</th></tr>" >> reporte_final.html
            while IFS= read -r line; do
              FILE=$(echo "$line" | sed -n 's/.*source="\(.*\)".*/\1/p')
              LINE=$(echo "$line" | sed -n 's/.*line="\([0-9]*\)".*/\1/p')
              MSG=$(echo "$line" | sed -n 's/.*message="\(.*\)".*/\1/p')
              EXPL=$(explain "$MSG")
              echo "<tr><td>$FILE</td><td>$LINE</td><td>$MSG</td><td>$EXPL</td></tr>" >> reporte_final.html
            done < cs_temp.txt
            echo "</table></div>" >> reporte_final.html
          fi

          # ----- PMD -----
          grep "<violation" target/pmd.xml > pmd_temp.txt || true
          if [ $(wc -l < pmd_temp.txt) -eq 0 ]; then
            echo "<div class='section'><h2> PMD</h2><p class='ok'> Sin problemas detectados.</p></div>" >> reporte_final.html
          else
            echo "<div class='section'><h2> PMD</h2><p class='warn'> Problemas detectados:</p><table><tr><th>Archivo</th><th>L铆nea</th><th>Descripci贸n</th><th>Explicaci贸n / Ejemplo</th></tr>" >> reporte_final.html
            while IFS= read -r line; do
              FILE=$(echo "$line" | sed -n 's/.*filename="\([^"]*\)".*/\1/p')
              LINE=$(echo "$line" | sed -n 's/.*beginline="\([^"]*\)".*/\1/p')
              MSG=$(echo "$line" | sed -n 's/.*>\(.*\)<.*/\1/p')
              EXPL=$(explain "$MSG")
              echo "<tr><td>$FILE</td><td>$LINE</td><td>$MSG</td><td>$EXPL</td></tr>" >> reporte_final.html
            done < pmd_temp.txt
            echo "</table></div>" >> reporte_final.html
          fi

          # ----- SpotBugs -----
          grep "<BugInstance" target/spotbugsXml.xml > sb_temp.txt || true
          if [ $(wc -l < sb_temp.txt) -eq 0 ]; then
            echo "<div class='section'><h2> SpotBugs</h2><p class='ok'> Sin bugs detectados.</p></div>" >> reporte_final.html
          else
            echo "<div class='section'><h2> SpotBugs</h2><p class='err'> Bugs detectados:</p><table><tr><th>Archivo</th><th>L铆nea</th><th>Tipo de Bug</th><th>Explicaci贸n / Ejemplo</th></tr>" >> reporte_final.html
            while IFS= read -r line; do
              TYPE=$(echo "$line" | sed -n 's/.*type="\([^"]*\)".*/\1/p')
              CLASS=$(echo "$line" | sed -n 's/.*classname="\([^"]*\)".*/\1/p' | sed 's/\./\//g')
              LINE=$(grep -A1 "$TYPE" target/spotbugsXml.xml | grep "<SourceLine" | head -1 | sed -n 's/.*start="\([0-9]*\)".*/\1/p')
              EXPL=$(explain "$TYPE")
              echo "<tr><td>$CLASS.java</td><td>$LINE</td><td>$TYPE</td><td>$EXPL</td></tr>" >> reporte_final.html
            done < sb_temp.txt
            echo "</table></div>" >> reporte_final.html
          fi

          echo "</body></html>" >> reporte_final.html

      # ------------------------------
      # 7. Subir reporte HTML final
      # ------------------------------
      - name: Subir reporte HTML
        uses: actions/upload-artifact@v4
        with:
          name: reporte_html
          path: reporte_final.html
