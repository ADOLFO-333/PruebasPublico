name: Leer C√≥digo - Seguridad y Buenas Pr√°cticas

on:
  workflow_dispatch:

jobs:
  validar_codigo:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # 1. Compilaci√≥n del Proyecto
      # ----------------------------------------------------------------------
      - name: Compilar proyecto
        run: mvn -q clean compile test-compile

      # ----------------------------------------------------------------------
      # 2. An√°lisis de C√≥digo
      # ----------------------------------------------------------------------
      - name: Checkstyle
        run: mvn -q checkstyle:check || true

      - name: PMD Analysis
        run: mvn -q pmd:pmd || true

      - name: SpotBugs Analysis
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:check || true

      # ----------------------------------------------------------------------
      # 3. Generar reporte HTML embellecido
      # ----------------------------------------------------------------------
      - name: Generar reporte HTML consolidado
        run: |
          cat << 'EOF' > reporte_final.html
          <html>
          <head>
            <title>Reporte Consolidado de An√°lisis</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1, h2 { color: #2F4F4F; }
              table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
              th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              tr:nth-child(even) { background-color: #fafafa; }
              .green { color: green; font-weight: bold; }
              .red { color: red; font-weight: bold; }
              .orange { color: orange; font-weight: bold; }
            </style>
          </head>
          <body>
          <h1>üéØ Reporte Consolidado de An√°lisis de C√≥digo</h1>
          <p>Este informe muestra los hallazgos de <b>Checkstyle</b>, <b>PMD</b> y <b>SpotBugs</b>. Incluye archivo, l√≠nea, descripci√≥n y recomendaci√≥n de soluci√≥n.</p>
          EOF

          # -----------------------------
          # Checkstyle
          # -----------------------------
          echo "<h2>üßπ Checkstyle ‚Äì Formato y Estilo</h2>" >> reporte_final.html
          grep "<error " target/checkstyle-result.xml > cs_temp.txt || true
          CS_COUNT=$(wc -l < cs_temp.txt)

          if [ "$CS_COUNT" -eq 0 ]; then
            echo "<p class='green'>Sin problemas detectados</p>" >> reporte_final.html
          else
            echo "<p class='red'>Problemas detectados: $CS_COUNT</p>" >> reporte_final.html
            echo "<table><tr><th>Archivo</th><th>L√≠nea</th><th>Descripci√≥n</th><th>Recomendaci√≥n</th></tr>" >> reporte_final.html
            while IFS= read -r line; do
              FILE=$(echo "$line" | sed -n 's/.*source="\(.*\)".*/\1/p')
              LINE=$(echo "$line" | sed -n 's/.*line="\([0-9]*\)".*/\1/p')
              MSG=$(echo "$line" | sed -n 's/.*message="\(.*\)".*/\1/p')
              RECOM="Corrige el formato o estilo seg√∫n Checkstyle"
              echo "<tr><td>$FILE</td><td>$LINE</td><td>$MSG</td><td>$RECOM</td></tr>" >> reporte_final.html
            done < cs_temp.txt
            echo "</table>" >> reporte_final.html
          fi

          # -----------------------------
          # PMD
          # -----------------------------
          echo "<h2>üìè PMD ‚Äì Buenas Pr√°cticas & Complejidad</h2>" >> reporte_final.html
          grep "<violation" target/pmd.xml > pmd_temp.txt || true
          PMD_COUNT=$(wc -l < pmd_temp.txt)

          if [ "$PMD_COUNT" -eq 0 ]; then
            echo "<p class='green'>Sin problemas detectados</p>" >> reporte_final.html
          else
            echo "<p class='orange'>Problemas detectados: $PMD_COUNT</p>" >> reporte_final.html
            echo "<table><tr><th>Archivo</th><th>L√≠nea</th><th>Descripci√≥n</th><th>Recomendaci√≥n</th></tr>" >> reporte_final.html
            while IFS= read -r line; do
              FILE=$(echo "$line" | sed -n 's/.*filename="\([^"]*\)".*/\1/p')
              LINE=$(echo "$line" | sed -n 's/.*beginline="\([^"]*\)".*/\1/p')
              MSG=$(echo "$line" | sed -n 's/.*>\(.*\)<.*/\1/p')
              RECOM="Revisar complejidad o duplicaci√≥n de c√≥digo seg√∫n PMD"
              echo "<tr><td>$FILE</td><td>$LINE</td><td>$MSG</td><td>$RECOM</td></tr>" >> reporte_final.html
            done < pmd_temp.txt
            echo "</table>" >> reporte_final.html
          fi

          # -----------------------------
          # SpotBugs
          # -----------------------------
          echo "<h2>üêõ SpotBugs ‚Äì Posibles Bugs Reales</h2>" >> reporte_final.html
          grep "<BugInstance" target/spotbugsXml.xml > sb_temp.txt || true
          SB_COUNT=$(wc -l < sb_temp.txt)

          if [ "$SB_COUNT" -eq 0 ]; then
            echo "<p class='green'>Sin bugs detectados</p>" >> reporte_final.html
          else
            echo "<p class='red'>Bugs detectados: $SB_COUNT</p>" >> reporte_final.html
            echo "<table><tr><th>Archivo</th><th>L√≠nea</th><th>Tipo de Bug</th><th>Recomendaci√≥n</th></tr>" >> reporte_final.html
            while IFS= read -r line; do
              TYPE=$(echo "$line" | sed -n 's/.*type="\([^"]*\)".*/\1/p')
              CLASS=$(echo "$line" | sed -n 's/.*classname="\([^"]*\)".*/\1/p' | sed 's/\./\//g')
              LINE=$(grep -A1 "$TYPE" target/spotbugsXml.xml | grep "<SourceLine" | head -1 | sed -n 's/.*start="\([0-9]*\)".*/\1/p')
              RECOM="Revisar bug potencial y prevenir NPE o errores l√≥gicos"
              echo "<tr><td>$CLASS.java</td><td>$LINE</td><td>$TYPE</td><td>$RECOM</td></tr>" >> reporte_final.html
            done < sb_temp.txt
            echo "</table>" >> reporte_final.html
          fi

          # -----------------------------
          # Recomendaciones Generales
          # -----------------------------
          echo "<h2>üí° Recomendaciones Generales</h2>" >> reporte_final.html
          echo "<ul>
            <li>Divide Tasks muy largas en subtareas Screenplay.</li>
            <li>Usa Page Objects limpios y descriptivos.</li>
            <li>Evita duplicaci√≥n en Steps/Interactions.</li>
            <li>Aplica formateo autom√°tico (Ctrl + Alt + L en IntelliJ).</li>
            <li>Revisa posibles NPE detectados por SpotBugs.</li>
            <li>Mant√©n clases por debajo de 300 l√≠neas para Screenplay.</li>
          </ul>" >> reporte_final.html

          echo "</body></html>" >> reporte_final.html

      # ----------------------------------------------------------------------
      # 4. Subir reportes
      # ----------------------------------------------------------------------
      - name: Subir reportes originales
        uses: actions/upload-artifact@v4
        with:
          name: reportes_detallados
          path: |
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
            target/pmd.html
            target/site/spotbugs.html

      - name: Subir reporte HTML embellecido
        uses: actions/upload-artifact@v4
        with:
          name: reporte_analisis_embellecido
          path: reporte_final.html
