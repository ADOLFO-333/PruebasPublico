name: Leer C칩digo - Seguridad y Buenas Pr치cticas

on:
  workflow_dispatch:

jobs:
  validar_codigo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Ejecutar Checkstyle
        run: mvn -q checkstyle:check || true

      - name: Ejecutar PMD
        run: mvn -q pmd:pmd || true

      - name: Ejecutar SpotBugs
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:spotbugs || true

      # ==========================================================
      # GENERAR REPORTE HTML FUNCIONAL
      # ==========================================================
      - name: Generar reporte HTML consolidado funcional
        run: |
          echo "<html><head><meta charset='UTF-8'>
          <style>
            body { font-family: Arial; margin: 20px; }
            h1 { color: #003366; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
            th { background: #004A99; color: white; padding: 8px; }
            td { border: 1px solid #ddd; padding: 6px; }
            tr:nth-child(even) { background: #f2f2f2; }
          </style>
          </head><body>" > reporte_final.html

          echo "<h1>游댍 Reporte Consolidado de Calidad</h1>" >> reporte_final.html

          # ===========================
          # CHECKSTYLE
          # ===========================
          echo "<h2>游빛 Checkstyle</h2>" >> reporte_final.html

          if [ -f target/checkstyle-result.xml ]; then
            COUNT=$(xmllint --xpath "count(/checkstyle/file/error)" target/checkstyle-result.xml 2>/dev/null)
          else
            COUNT=0
          fi

          if [ "$COUNT" -eq 0 ]; then
            echo "<p>No se detectaron problemas.</p>" >> reporte_final.html
          else
            echo "<table><tr><th>Archivo</th><th>L칤nea</th><th>Descripci칩n</th></tr>" >> reporte_final.html

            xmllint --xpath "//file" target/checkstyle-result.xml 2>/dev/null |
            tr '<' '\n<' |
            grep "<file" |
            while read -r FILELINE; do

              FILEPATH=$(echo "$FILELINE" | sed -n 's/.*name="\([^"]*\)".*/\1/p')

              xmllint --xpath "//file[@name=\"$FILEPATH\"]/error" target/checkstyle-result.xml 2>/dev/null |
              tr '<' '\n<' |
              grep "<error" |
              while read -r ERR; do
                LINE=$(echo "$ERR" | sed -n 's/.*line="\([^"]*\)".*/\1/p')
                MSG=$(echo "$ERR" | sed -n 's/.*message="\([^"]*\)".*/\1/p')

                echo "<tr><td>$FILEPATH</td><td>$LINE</td><td>$MSG</td></tr>" >> reporte_final.html
              done
            done

            echo "</table>" >> reporte_final.html
          fi

          # ===========================
          # PMD
          # ===========================
          echo "<h2>游늺 PMD</h2>" >> reporte_final.html

          if [ -f target/pmd.xml ]; then
            COUNT=$(xmllint --xpath "count(/pmd/file/violation)" target/pmd.xml 2>/dev/null)
          else
            COUNT=0
          fi

          if [ "$COUNT" -eq 0 ]; then
            echo "<p>No se detectaron violaciones.</p>" >> reporte_final.html
          else
            echo "<table><tr><th>Archivo</th><th>L칤nea</th><th>Descripci칩n</th></tr>" >> reporte_final.html

            xmllint --xpath "//file" target/pmd.xml 2>/dev/null |
            tr '<' '\n<' |
            grep "<file" |
            while read -r BLOCK; do
              FILE=$(echo "$BLOCK" | sed -n 's/.*name="\([^"]*\)".*/\1/p')

              xmllint --xpath "//file[@name=\"$FILE\"]/violation" target/pmd.xml 2>/dev/null |
              tr '<' '\n<' |
              grep "<violation" |
              while read -r V; do
                LINE=$(echo "$V" | sed -n 's/.*beginline="\([^"]*\)".*/\1/p')
                MSG=$(echo "$V" | sed -n 's/.*>\(.*\)<.*/\1/p')

                echo "<tr><td>$FILE</td><td>$LINE</td><td>$MSG</td></tr>" >> reporte_final.html
              done
            done

            echo "</table>" >> reporte_final.html
          fi

          # ===========================
          # SPOTBUGS
          # ===========================
          echo "<h2>游냍 SpotBugs</h2>" >> reporte_final.html

          if ! grep -q "<BugInstance" target/spotbugsXml.xml 2>/dev/null; then
            echo "<p>No se detectaron bugs.</p>" >> reporte_final.html
          else
            echo "<table><tr><th>Archivo</th><th>L칤nea</th><th>Tipo</th></tr>" >> reporte_final.html

            grep "<BugInstance" -A2 target/spotbugsXml.xml |
            while read -r LINE; do
              TYPE=$(echo "$LINE" | sed -n 's/.*type="\([^"]*\)".*/\1/p')

              FILE=$(grep -A3 "$TYPE" target/spotbugsXml.xml | grep SourceLine | sed -n 's/.*sourcefile="\([^"]*\)".*/\1/p' | head -1)
              LINENUM=$(grep -A3 "$TYPE" target/spotbugsXml.xml | grep SourceLine | sed -n 's/.*start="\([^"]*\)".*/\1/p' | head -1)

              if [ ! -z "$TYPE" ]; then
                echo "<tr><td>$FILE</td><td>$LINENUM</td><td>$TYPE</td></tr>" >> reporte_final.html
              fi
            done

            echo "</table>" >> reporte_final.html
          fi

          echo "</body></html>" >> reporte_final.html

      - name: Subir reporte HTML
        uses: actions/upload-artifact@v4
        with:
          name: reporte_html
          path: reporte_final.html
