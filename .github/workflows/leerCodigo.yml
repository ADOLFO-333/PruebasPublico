name: Leer CÃ³digo - Seguridad y Buenas PrÃ¡cticas

on:
  workflow_dispatch:

jobs:
  validar_codigo:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # 1. CompilaciÃ³n del Proyecto
      # ----------------------------------------------------------------------
      - name: Compilar proyecto
        run: mvn -q clean compile test-compile

      # ----------------------------------------------------------------------
      # 2. AnÃ¡lisis de CÃ³digo
      # ----------------------------------------------------------------------

      - name: Checkstyle
        run: mvn -q checkstyle:check || true

      - name: PMD Analysis
        run: mvn -q pmd:pmd || true

      - name: SpotBugs Analysis
        run: mvn -q com.github.spotbugs:spotbugs-maven-plugin:check || true

      # ----------------------------------------------------------------------
      # 3. REPORTE CONSOLIDADO AVANZADO Y EMBELLECIDO
      # ----------------------------------------------------------------------
      - name: Generar reporte consolidado embellecido
        run: |
          echo "# ðŸŽ¯ Reporte Consolidado de AnÃ¡lisis de CÃ³digo" > reporte_final.md
          echo "" >> reporte_final.md
          echo "Este informe resume los hallazgos de **Checkstyle**, **PMD** y **SpotBugs**." >> reporte_final.md
          echo "Incluye ubicaciÃ³n exacta, descripciÃ³n del problema y recomendaciones de soluciÃ³n." >> reporte_final.md
          echo "---" >> reporte_final.md
          echo "" >> reporte_final.md

          # =======================
          # EXTRAER CHECKSTYLE
          # =======================
          echo "## ðŸ§¹ Checkstyle â€“ Formato y Estilo" >> reporte_final.md
          grep "<error " target/checkstyle-result.xml > cs_temp.txt || true
          CS_COUNT=$(wc -l < cs_temp.txt)

          if [ "$CS_COUNT" -eq 0 ]; then
            echo "- ðŸŸ¢ **Sin problemas detectados**" >> reporte_final.md
          else
            echo "- ðŸ”´ Problemas detectados: **$CS_COUNT**" >> reporte_final.md
            echo "" >> reporte_final.md
            echo "| Archivo | LÃ­nea | DescripciÃ³n |" >> reporte_final.md
            echo "|---------|--------|-------------|" >> reporte_final.md

            while IFS= read -r line; do
              FILE=$(echo "$line" | sed -n 's/.*source="\(.*\)".*/\1/p')
              MSG=$(echo "$line" | sed -n 's/.*message="\(.*\)".*/\1/p')
              LINE=$(echo "$line" | sed -n 's/.*line="\([0-9]*\)".*/\1/p')

              echo "| $FILE | $LINE | $MSG |" >> reporte_final.md
            done < cs_temp.txt
          fi

          echo "" >> reporte_final.md
          echo "---" >> reporte_final.md

          # =======================
          # EXTRAER PMD
          # =======================
          echo "## ðŸ“ PMD â€“ Buenas PrÃ¡cticas & Complejidad" >> reporte_final.md
          grep "<violation" target/pmd.xml > pmd_temp.txt || true
          PMD_COUNT=$(wc -l < pmd_temp.txt)

          if [ "$PMD_COUNT" -eq 0 ]; then
            echo "- ðŸŸ¢ **Sin problemas detectados**" >> reporte_final.md
          else
            echo "- ðŸŸ  Problemas detectados: **$PMD_COUNT**" >> reporte_final.md
            echo "" >> reporte_final.md
            echo "| Archivo | LÃ­nea | DescripciÃ³n |" >> reporte_final.md
            echo "|---------|--------|-------------|" >> reporte_final.md

            while IFS= read -r line; do
              FILE=$(echo "$line" | sed -n 's/.*filename="\([^"]*\)".*/\1/p')
              BEGIN=$(echo "$line" | sed -n 's/.*beginline="\([^"]*\)".*/\1/p')
              MSG=$(echo "$line" | sed -n 's/.*>\(.*\)<.*/\1/p')

              echo "| $FILE | $BEGIN | $MSG |" >> reporte_final.md
            done < pmd_temp.txt
          fi

          echo "" >> reporte_final.md
          echo "---" >> reporte_final.md

          # =======================
          # EXTRAER SPOTBUGS
          # =======================
          echo "## ðŸ› SpotBugs â€“ Posibles Bugs Reales" >> reporte_final.md
          grep "<BugInstance" target/spotbugsXml.xml > sb_temp.txt || true
          SB_COUNT=$(wc -l < sb_temp.txt)

          if [ "$SB_COUNT" -eq 0 ]; then
            echo "- ðŸŸ¢ **Sin bugs detectados**" >> reporte_final.md
          else
            echo "- ðŸ”´ Bugs detectados: **$SB_COUNT**" >> reporte_final.md
            echo "" >> reporte_final.md
            echo "| Archivo | LÃ­nea | Tipo de Bug |" >> reporte_final.md
            echo "|---------|--------|-------------|" >> reporte_final.md

            while IFS= read -r line; do
              TYPE=$(echo "$line" | sed -n 's/.*type="\([^"]*\)".*/\1/p')
              CLASS=$(echo "$line" | sed -n 's/.*classname="\([^"]*\)".*/\1/p' | sed 's/\./\//g')
              LINE=$(grep -A1 "$TYPE" target/spotbugsXml.xml | grep "<SourceLine" | head -1 | sed -n 's/.*start="\([0-9]*\)".*/\1/p')

              echo "| $CLASS.java | $LINE | $TYPE |" >> reporte_final.md
            done < sb_temp.txt
          fi

          echo "" >> reporte_final.md
          echo "---" >> reporte_final.md

          # =======================
          # RECOMENDACIONES FINALES
          # =======================
          echo "## ðŸ’¡ Recomendaciones Generales" >> reporte_final.md
          echo "- Divide Tasks muy largas en subtareas Screenplay." >> reporte_final.md
          echo "- Usa Page Objects limpios y descriptivos." >> reporte_final.md
          echo "- Evita duplicaciÃ³n en Steps/Interactions." >> reporte_final.md
          echo "- Aplica formateo automÃ¡tico (Ctrl + Alt + L en IntelliJ)." >> reporte_final.md
          echo "- Revisa posibles NPE detectados por SpotBugs." >> reporte_final.md
          echo "- MantÃ©n clases por debajo de 300 lÃ­neas para Screenplay." >> reporte_final.md

      # ----------------------------------------------------------------------
      # 4. SUBIR RESULTADOS
      # ----------------------------------------------------------------------
      - name: Subir reportes originales
        uses: actions/upload-artifact@v4
        with:
          name: reportes_detallados
          path: |
            target/checkstyle-result.xml
            target/pmd.xml
            target/spotbugsXml.xml
            target/pmd.html
            target/site/spotbugs.html

      - name: Subir reporte embellecido
        uses: actions/upload-artifact@v4
        with:
          name: reporte_analisis_embellecido
          path: reporte_final.md
